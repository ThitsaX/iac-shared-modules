- name: Update apt cache
  shell: apt update

- name: Install dependencies
  package:
    name:
      - docker.io
      - docker-compose 
      - wireguard

- name: enable service docker and ensure it is started
  service:
    name: docker
    enabled: yes
    state: started

- name: "create directory for project"
  file:
    path: "{{ root_dir }}"
    state: directory
    recurse: yes

- name: "deploy systemd service"
  template:
    src: "../templates/netmaker.service.j2"
    dest: "/etc/systemd/system/netmaker.service"
  register: service


- name: "deploy docker compose file"
  template:
    src: "../templates/netmaker.docker-compose.yml.j2"
    dest: "{{ root_dir}}/docker-compose.yml"
  register: compose

- name: "deploy docker mosquito file"
  template:
    src: "../templates/mosquitto.conf.j2"
    dest: "{{ root_dir}}/mosquitto.conf"
  register: compose

- name: "set to auto restart"
  systemd:
    enabled: "yes"
    daemon_reload: yes
    name: "netmaker"
